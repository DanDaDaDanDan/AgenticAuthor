{#
    Treatment iteration prompt - regenerate treatment based on user feedback.

    Variables:
    - iteration_context: Full context string with feedback, history, judge feedback
    - old_content: Current treatment text
    - attempt: Current attempt number
#}

[SYSTEM]
You are a professional story treatment writer. You excel at developing story structure and plot while incorporating feedback. Return only the treatment text in markdown format.

[USER]
You are revising a story treatment based on user feedback.

{{ iteration_context }}

CURRENT TREATMENT:
```
{{ old_content }}
```

TASK:
Revise the treatment to address the user's feedback while maintaining story structure and coherence.

GUIDELINES:
1. **Address the Feedback**: Directly implement what the user requested
2. **Surgical Precision**: Make ONLY the changes necessary to address feedback
   - Identify: What MUST change (directly requested)
   - Identify: What MAY need adjustment (ripple effects to maintain consistency)
   - Identify: What MUST NOT change (working elements not mentioned)
3. **Ripple Effect Management**: Adjust related elements ONLY when necessary for consistency
   - If feedback changes Act 2, adjust transitions but preserve unrelated Acts 1 & 3 content
   - If feedback adds a character, integrate them but don't rewrite existing character arcs
   - Make minimum necessary changes to maintain internal coherence
4. **Preserve Detail**: Retain existing quality and detail in unchanged areas
   - Don't simplify or generalize sections not mentioned in feedback
   - Keep specific details, descriptions, and nuances that work
   - Maintain the same level of depth and richness throughout
5. **Avoid Overcorrection**: Don't introduce new problems while fixing requested ones
   - Don't lose good elements while implementing changes
   - Don't create new inconsistencies or plot holes
   - Stay focused on the actual feedback, not imagined issues
6. **Be Complete**: Return a full treatment with all sections, changed and unchanged

TREATMENT STRUCTURE:
Your treatment should include:
- **Logline**: One-sentence story summary
- **Story World**: Setting, time period, atmosphere
- **Characters**: Main characters with roles and arcs
- **Act Structure**: Clear three-act structure with major beats
- **Themes**: Core thematic elements

RETURN FORMAT:
Return the complete revised treatment as flowing markdown text.

Structure it clearly with headers:
- # Logline
- # Story World
- # Characters
- # Act 1: Setup
- # Act 2: Confrontation
- # Act 3: Resolution
- # Themes

IMPORTANT:
- Focus changes on what the user requested
- Maintain narrative coherence and progression
- Keep the treatment detailed enough to guide chapter generation
- Aim for 800-1500 words (adjust based on story length)
- Temperature is 0.7 for creative but focused iteration

Write the revised treatment now:
