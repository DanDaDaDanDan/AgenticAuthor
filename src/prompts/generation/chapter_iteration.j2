{#
    Chapter iteration prompt - regenerate chapter outlines based on user feedback.

    Variables:
    - iteration_context: Full context string with feedback, history, judge feedback
    - old_content: Current chapters (foundation + all chapters as markdown)
    - attempt: Current attempt number
#}

[SYSTEM]
You are a professional story architect who excels at crafting detailed chapter outlines. You create compelling narrative structures while incorporating feedback. Return only markdown text with clear chapter separations.

[USER]
You are revising chapter outlines based on user feedback.

{{ iteration_context }}

CURRENT CHAPTER OUTLINES:
```
{{ old_content }}
```

TASK:
Revise the chapter outlines to address the user's feedback while maintaining story coherence and structure.

IMPORTANT: You are regenerating BOTH foundation AND chapters in this single call because:
- Changes to chapters may require foundation metadata updates (tone, themes, structure)
- Changes to foundation may require chapter content adjustments
- This ensures internal consistency between foundation and chapter content
- Initial generation uses TWO calls (foundation first, then chapters), but iteration uses ONE call for holistic revision

GUIDELINES:
1. **Address the Feedback**: Directly implement what the user requested
2. **Surgical Precision**: Make ONLY the changes necessary to address feedback
   - Identify: What MUST change (directly requested chapters/elements)
   - Identify: What MAY need adjustment (adjacent chapters, transitions, character arcs, foundation metadata if affected)
   - Identify: What MUST NOT change (unrelated chapters, unaffected foundation elements)
3. **Ripple Effect Management**: Adjust related elements ONLY when necessary for consistency
   - If feedback changes Chapter 5, adjust Chapter 6 transitions but preserve Chapters 1-4 & 7+ unless directly affected
   - If feedback changes tone/themes across chapters, update foundation metadata to reflect this
   - If feedback removes a plot thread, update only chapters that reference it (foundation character/world descriptions stay unless affected)
   - If feedback adds a character to chapters, add them to foundation characters section
   - Make minimum necessary changes to maintain story flow and foundation accuracy
4. **Preserve Detail**: Retain existing structure and detail in unchanged elements
   - Don't rewrite chapters not mentioned in feedback
   - Don't rewrite foundation sections not affected by changes (preserve character descriptions, world-building details, metadata)
   - Keep specific key events, character beats, and emotional arcs that work
   - Maintain the same level of detail and richness in untouched chapters and foundation sections
5. **Avoid Overcorrection**: Don't introduce new problems while fixing requested ones
   - Don't create new plot holes or inconsistencies
   - Don't lose good elements in chapters adjacent to changes
   - Stay focused on the actual feedback, not imagined issues
6. **Maintain Coherence**: Ensure chapters flow logically after targeted changes
7. **Be Complete**: Return ALL chapters (foundation + all chapter outlines)

CHAPTER OUTLINE FORMAT (BEAT SHEET STYLE):
⚠️ CRITICAL: Use the EXACT same format as initial generation to maintain consistency.

Each chapter MUST include ALL these fields in this order:
- **Act designation** (Act I, Act II, Act III)
- **POV character**
- **Primary Operation Type** (investigation|confrontation|chase|negotiation|etc.)
- **Key Events (Beats)** using Action → Result format with bullet points
- **Character Development** with specific character changes
- **Emotional Beat** (single sentence capturing emotional core)
- **New Information** (single sentence)
- **Hook Type** (question|reversal|deadline|forced-choice|loss|betrayal|ambush)

BEAT SHEET PRINCIPLES:
- Write beats as: "- [Action/Event] → [Consequence/Result]"
- Present tense, structural descriptions (not prose)
- Each beat = major plot point that becomes a scene in prose
- 4-6 beats per chapter typically
- Focus on WHAT happens and WHY it matters to story

RETURN FORMAT:
Return the complete revised content as markdown, separated by `---` markers:

```
# Foundation

[Foundation content with metadata, characters, world - maintain exact structure]

---

# Chapter 1: [Title]

**Act:** Act I
**POV:** [Name]
**Primary Operation Type:** [investigation|confrontation|...]

**Key Events (Beats):**
- [Beat 1: Action/Event → Consequence/Result]
- [Beat 2: Action/Event → Consequence/Result]
- [Beat 3: Action/Event → Consequence/Result]
- [Beat 4: Action/Event → Consequence/Result]
- [Beat 5: Action/Event → Consequence/Result]

**Character Development:**
- [Name: concrete change with evidence]
- [Name: concrete change with evidence]

**Emotional Beat:** [One sentence capturing chapter's emotional core]
**New Information:** [One sentence]
**Hook Type:** [question|reversal|deadline|forced-choice|loss|betrayal|ambush]

---

# Chapter 2: [Title]

**Act:** Act I/II/III
**POV:** [Name]
**Primary Operation Type:** [type]

**Key Events (Beats):**
- [Beat 1: Action → Result]
- [Beat 2: Action → Result]
- [Beat 3: Action → Result]
- [Beat 4: Action → Result]

**Character Development:**
- [Name: change]

**Emotional Beat:** [Emotional core]
**New Information:** [One sentence]
**Hook Type:** [type]

---

[Continue for all chapters maintaining exact format]
```

CRITICAL FORMAT REQUIREMENTS:
- Separate foundation and each chapter with `---` on its own line
- Use EXACT format from generation (including Act, Primary Operation Type, Emotional Beat, New Information, Hook Type)
- Maintain beat sheet style: "- Action → Result" with bullet points (NOT numbered lists)
- Focus changes on what the user requested
- Preserve ALL formatting fields even for unchanged chapters
- Maintain narrative progression and avoid duplicate events
- Use 4-6 beats per chapter typically
- Ensure each chapter advances the story uniquely
- Temperature is 0.7 for creative but focused iteration

⚠️ DO NOT simplify the format or remove fields - maintain exact structure for consistency!

Write the revised chapter outlines now:
