{#
    Single-shot chapter generation - all chapters in one call.

    Variables:
    - context_yaml: Full premise + treatment as YAML
    - foundation_yaml: Foundation (metadata + characters + world) as YAML
    - chapter_count: Number of chapters to generate
    - feedback: Optional user feedback for iteration
#}

[SYSTEM]
You are a professional story development assistant. You create comprehensive chapter outlines with unique plot events and progressive character development. You always return valid YAML without additional formatting.

YAML RULES (STRICT):
- All list items MUST be fully quoted strings. Format exactly: - "Text here"
- Never include colons in unquoted list items
- No markdown fences or commentary — YAML only

[USER]
Generate a comprehensive chapter structure for a book.

INPUT CONTEXT:
```yaml
{{ context_yaml }}
```

FOUNDATION (already generated):
```yaml
{{ foundation_yaml }}
```

TASK:
Generate {{ chapter_count }} comprehensive chapter outlines for the complete story.
The foundation (metadata, characters, world) has already been generated above.

CRITICAL - PLAN THE COMPLETE ARC:
Since you're generating ALL chapters at once, you have the unique opportunity to:
- Plan the entire story progression before committing to any chapter
- Distribute character development evenly across the arc
- Ensure each chapter has a UNIQUE role in the story
- Avoid duplicating plot beats or character moments
- Create clear causal progression from chapter to chapter

ANTI-REDUNDANCY GUARDRAILS (Act II especially):
- Do not repeat similar operation types (e.g., multiple stakeouts/raids/canvasses). If a pattern would repeat, CONSOLIDATE into a single, higher-impact chapter.
- Vary setting and tactics — escalate stakes and method rather than replaying the same beat.
- Each chapter should introduce at least one new piece of information OR a meaningful turn in relationships.

CHAPTER STRUCTURE:
For each chapter provide:
- number, title (evocative, specific)
- pov, act (Act I/Act II/Act III based on position), summary (3-4 sentences)
- key_events: 3-5 major plot points (each will become a complete scene in prose - UNIQUE to this chapter, not repeated)
- character_developments: 3-4 internal changes (LINEAR progression, no repeated beats). Format each as "Name: concrete change with evidence" (e.g., "Elias: trusts Lena's intuition after failed predictive model").
- relationship_beats: 2-3 relationship evolutions (UNIQUE dynamics)
- tension_points: 2-3 stakes/urgency moments
- sensory_details: 2-3 atmospheric elements
- subplot_threads: 1-2 if applicable

GUIDELINES FOR KEY_EVENTS - CRITICAL:
- Each key_event should be SCENE-LEVEL, not beat-level
- Think: "What are the 3-5 major scenes in this chapter?" NOT "What are all the small beats?"
- Each key_event will expand into a full dramatic scene (1,000-2,000 words) in prose
- Consolidate related beats into a single event (e.g., "Character arrives at location, examines evidence, discovers clue" = ONE event)
- AVOID fragmentation: Don't break a single interaction into multiple events
- Example of TOO GRANULAR (beat-level): "Character arrives", "Character examines body", "Character discovers clue", "Character talks to witness"
- Example of CORRECT (scene-level): "Character examines crime scene, discovering crucial clue while interviewing witness"

ACT DISTRIBUTION & PROGRESSION:
- Act I (~25%): Establish premise, inciting incident, clear story question. No filler scenes.
- Act II (~50%): Escalate through varied strategies (investigation, confrontation, reversal). Avoid repeating the same tactic twice; merge near-duplicate beats.
- Act III (~25%): Execute decisive moves, climax, and resolution with consequences.

GENERAL GUIDELINES:
- Each key_event should be specific and complete (not vague or generic)
- Character developments show PROGRESSIVE internal change (no resets or repeats)
- Relationship beats track EVOLVING dynamics (each interaction builds on previous)
- Be specific with names, places, emotions, concrete details
- Act I: ~25% chapters (setup and introduction)
- Act II: ~50% chapters (rising action and complications)
- Act III: ~25% chapters (climax and resolution)
{% if feedback %}

USER FEEDBACK: {{ feedback }}

Please incorporate the above feedback while generating the chapters.
{% endif %}

RETURN FORMAT:
Return ONLY valid YAML (no markdown fences):

chapters:
  - number: 1
    title: "..."
    pov: "..."
    act: "Act I"
    summary: "..."
    key_events:
      - "First major scene/plot point (scene-level, will expand to 1,000-2,000 words)"
      - "Second major scene/plot point"
      - "Third major scene/plot point"
      - "Fourth major scene/plot point (optional)"
      - "Fifth major scene/plot point (optional)"
    character_developments:
      - "Name: concrete internal change with evidence"
      - "Name: specific shift caused by a scene outcome"
      - "Name: decision that advances arc"
    relationship_beats:
      - "First relationship change"
      - "Second relationship change"
    tension_points:
      - "First tension point"
      - "Second tension point"
    sensory_details:
      - "First sensory detail"
      - "Second sensory detail"
    subplot_threads:
      - "First subplot thread"
  - number: 2
    title: "..."
    # ... continue for all {{ chapter_count }} chapters

YAML SYNTAX RULES:
- ALWAYS wrap ALL list items in double quotes: - "Event text"
- For dialogue in events, use single quotes inside doubles: - "He said: 'Hello'."
- Do NOT wrap in markdown code fences

IMPORTANT:
- Return ONLY the YAML content starting with "chapters:"
- Each chapter must have UNIQUE plot events (no duplication across chapters)
- Character arcs must PROGRESS linearly (no repeated development beats)
- Follow YAML syntax rules above to avoid parsing errors
