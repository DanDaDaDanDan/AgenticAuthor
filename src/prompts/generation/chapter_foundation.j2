{#
    Chapter foundation generation prompt (metadata + characters + world).

    Variables:
    - context_yaml: Full premise + treatment as YAML
    - unique_context: Original concept and unique elements text
    - metadata_yaml_example: Pre-formatted metadata YAML example
    - total_words: Target total word count
    - chapter_count: Number of chapters
    - feedback: Optional iteration feedback
    - is_initial_generation: Boolean for first-time generation
    - min_words: Minimum word count from form range
    - max_words: Maximum word count from form range
    - genre_baseline: Genre-based default word count
    - genre: Genre name
    - length_scope: Form name (e.g., "novel")
#}

[SYSTEM]
You are a professional story development assistant. You write in clear, natural markdown format.

[USER]
# TREATMENT
```yaml
{{ context_yaml }}
```
{{ unique_context }}
# YOUR TASK
Generate foundation (metadata + characters + world) from the treatment above.

Note: Extract and structure what's in the treatment. Elaborate fully but don't invent major plot elements.

# OUTPUT
Write in natural markdown format:

# Metadata

**Genre:** [genre from treatment]
**Subgenre:** [if applicable]
**Tone:** [tone and style]
**Pacing:** [pacing style]
**Themes:**
  - [theme 1]
  - [theme 2]
  - [etc.]
**Story Structure:** [structure type]
**Narrative Style:** [POV and style]
**Target Audience:** [audience description]
**Target Word Count:** [number]
**Chapter Count:** [number]
**Setting Period:** [time period]
**Setting Location:** [location]
**Content Warnings:**
  - [if applicable]

# Characters

## [Character Name]

**Role:** protagonist/antagonist/supporting
**Background:** [Full background description]
**Motivation:** [Character's driving motivation]
**Character Arc:** [How they change throughout the story]
**Personality Traits:**
  - [trait 1]
  - [trait 2]
**Internal Conflict:** [Their inner struggle]
**Relationships:**
  - [Other Character]: [Dynamic description]

[Continue for all characters]

# World

**Setting Overview:** [Overall setting description]

**Key Locations:**
  - **[Location Name]:** [Description]
  - **[Location Name]:** [Description]

**Systems and Rules:**
  - **[System Name]:** [Description of how it works]

**Social Context:**
  - [Social element 1]
  - [Social element 2]

IMPORTANT: Include all 3 sections (Metadata, Characters, World). Write naturally without worrying about perfect formatting.
{% if is_initial_generation and min_words and max_words %}

TREATMENT ANALYSIS FOR WORD COUNT:

Before setting target_word_count, analyze the treatment to determine the story's natural scope.

Consider these factors from the treatment:
1. STORY COMPLEXITY: How many major plot threads are outlined?
2. CHARACTER COUNT: How many characters have significant roles?
3. WORLD-BUILDING NEEDS: How much setting/system explanation is required?
4. SUBPLOT DENSITY: How many parallel storylines are present?
5. NATURAL PACING: Does the story suggest fast-paced action (fewer words) or deliberate literary exploration (more)?
6. TIMELINE: Do events span days/weeks (shorter) or months/years (longer)?

CONSTRAINTS:
- Genre: {{ genre or 'general' }}
- Length scope: {{ length_scope }} ({{ "{:,}".format(min_words) }}-{{ "{:,}".format(max_words) }} words)
- Genre baseline: {{ "{:,}".format(genre_baseline) }} words (reference only - DO NOT default to this)

CRITICAL: Set target_word_count based on the treatment's ACTUAL COMPLEXITY within the {{ length_scope }} range ({{ "{:,}".format(min_words) }}-{{ "{:,}".format(max_words) }}).

Examples of organic word count selection:
- Tight thriller with single plot thread, 2-3 main characters, fast pacing → {{ "{:,}".format((min_words * 1.2)|int) }} words
- Complex mystery with multiple suspects, intricate plotting, moderate pacing → {{ "{:,}".format(((min_words + max_words) / 2)|int) }} words
- Epic with extensive world-building, large cast, multiple subplots → {{ "{:,}".format((max_words * 0.9)|int) }} words

Your choice should reflect the treatment's inherent scope, not just match the genre default.
{% endif %}
{% if feedback %}

USER FEEDBACK:
{{ feedback }}

CRITICAL INSTRUCTION: Analyze the feedback's structural intent before setting target_word_count and chapter_count.

Current baseline: {{ "{:,}".format(total_words) }} words, {{ chapter_count }} chapters

STEP 1: Identify the feedback's overall intent by looking for these indicators:

CONSOLIDATION INDICATORS (→ REDUCE both word count and chapter count):
  Keywords: "consolidate", "combine", "merge", "tighten", "condense", "streamline"
  Problems: "padded", "repetitive", "redundant", "dragging", "slow", "bloated"
  Actions: "remove", "cut", "trim", "reduce", "eliminate"

  If feedback contains these → REDUCE by 15-25%
  Example: {{ "{:,}".format(total_words) }} words → {{ "{:,}".format((total_words * 0.75)|int) }}-{{ "{:,}".format((total_words * 0.85)|int) }} words
           {{ chapter_count }} chapters → {{ (chapter_count * 0.75)|int }}-{{ (chapter_count * 0.85)|int }} chapters

EXPANSION INDICATORS (→ INCREASE both word count and chapter count):
  Keywords: "expand", "develop", "add more", "deepen", "flesh out", "elaborate"
  Problems: "rushed", "underdeveloped", "needs more", "too brief", "shallow"
  Actions: "add", "extend", "grow", "enrich"

  If feedback contains these → INCREASE by 15-25%
  Example: {{ "{:,}".format(total_words) }} words → {{ "{:,}".format((total_words * 1.15)|int) }}-{{ "{:,}".format((total_words * 1.25)|int) }} words
           {{ chapter_count }} chapters → {{ (chapter_count * 1.15)|int }}-{{ (chapter_count * 1.25)|int }} chapters

MIXED/REFINEMENT (→ minimal or no adjustment):
  Feedback addresses specific scenes/moments without overall length concerns
  Both consolidation and expansion requested in different areas
  Focus on content changes rather than structural changes

  If mixed signals → Adjust by less than 10% or keep current
  Example: {{ "{:,}".format(total_words) }} words → {{ "{:,}".format((total_words * 0.95)|int) }}-{{ "{:,}".format(total_words) }} words
           {{ chapter_count }} chapters → {{ [chapter_count - 2, 1]|max }}-{{ chapter_count }} chapters

STEP 2: Set your target_word_count and chapter_count based on your analysis above.

Your values should reflect the feedback's structural intent, not just specific edits.
If feedback clearly indicates consolidation (e.g., mentions "padded", "repetitive", "combine chapters"), you SHOULD reduce both metrics proportionally.

CRITICAL - AVOID DUPLICATE EVENTS IN ITERATION:
When the feedback mentions duplicate or repetitive content:
- This means previous chapter generation created redundant scenes/events
- Your job is to consolidate the structure to PREVENT duplication
- Review the existing chapters carefully and eliminate duplicate plot beats
- Each chapter should cover UNIQUE story events and character moments
- Do NOT create separate chapters for events that should be combined into one
{% endif %}
