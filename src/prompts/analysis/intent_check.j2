{#
    Intent analysis for natural language feedback.

    Variables:
    - project_name: Project name
    - genre: Story genre
    - status: Project status
    - has_premise: "Yes" or "No"
    - has_treatment: "Yes" or "No"
    - chapter_count: Number of chapters
    - prose_chapters: Number of chapters with prose
    - default_target: Default iteration target (optional)
    - feedback: User's feedback text
#}

[SYSTEM]
You are an expert at analyzing user intent. Always respond with valid JSON only.

[USER]
You are analyzing user feedback for a book generation system.

Project Context:
- Project: {{ project_name }}
- Genre: {{ genre }}
- Current Status: {{ status }}

Available Content:
- Premise: {{ has_premise }}
- Treatment: {{ has_treatment }}
- Chapters: {{ chapter_count }} chapters
- Prose: {{ prose_chapters }} chapters with prose

{% if default_target %}
Default Iteration Target: {{ default_target }}
(User has set this as their focus area - if feedback doesn't specify a different target, assume this one)
{% endif %}

User Feedback: "{{ feedback }}"

Analyze the intent and respond with ONLY valid JSON (no other text):

{
  "intent_type": "modify|add|remove|regenerate|analyze|clarify",
  "confidence": 0.0-1.0,
  "target_type": "premise|treatment|chapter|chapters|prose|taxonomy|project",
  "target_id": "specific identifier or null",
  "scope": "specific|section|multiple|entire",
  "action": "add_dialogue|fix_plot|enhance_description|change_tone|add_chapter|etc",
  "description": "clear description of what user wants",
  "reasoning": "why you classified it this way"
}

Guidelines:
- intent_type: What kind of change is requested
  * modify: Change existing content
  * add: Add new content
  * remove: Remove content
  * regenerate: Complete regeneration with new direction
  * analyze: Request analysis (not iteration)
  * clarify: Need more information

- confidence: How confident you are (0.0 to 1.0)
  * >0.8: High confidence, can execute
  * <0.8: Need clarification

- target_type: What part of the project
  * premise: Story premise
  * treatment: Treatment document
  * chapter: Specific chapter (set target_id)
  * chapters: Multiple chapters (set target_id like "3-5")
  * prose: Prose content
  * taxonomy: Genre/style metadata
  * project: Project-wide changes

- target_id: Specific identifier (chapter number, range, etc.) or null

- scope: How broad is the change
  * specific: Single, localized change
  * section: Part of a chapter/document
  * multiple: Multiple chapters/sections
  * entire: Whole document/project

- action: What action to take (use underscores, be specific)

- reasoning: Brief explanation of your classification

Be specific and confident. If unclear, set confidence < 0.8 and intent_type = "clarify".
