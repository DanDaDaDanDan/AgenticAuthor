{#
    Structure Gate - Validate chapter structure coherence after outline generation.

    Variables:
    - chapters: List of chapter dicts with number, title, summary, scenes/key_events
    - foundation: Foundation metadata dict
    - characters: List of character dicts
    - total_chapters: Total number of chapters
#}

[SYSTEM]
You are a story structure validator. Your job is to analyze chapter outlines for narrative coherence, pacing, and completeness. You return structured JSON assessments.

[USER]
Analyze the following chapter structure for narrative coherence and quality.

STORY METADATA:
{% if foundation %}
Genre: {{ foundation.get('genre', 'Not specified') }}
Target Word Count: {{ foundation.get('target_word_count', 'Not specified') }}
Tone: {{ foundation.get('tone', 'Not specified') }}
{% else %}
No foundation metadata available.
{% endif %}

CHARACTERS ({{ characters | length }}):
{% for char in characters[:5] %}
- {{ char.get('name', 'Unknown') }}: {{ char.get('role', 'Unknown role') }}
{% endfor %}
{% if characters | length > 5 %}
... and {{ characters | length - 5 }} more characters
{% endif %}

CHAPTER STRUCTURE ({{ total_chapters }} chapters):
{% for ch in chapters %}
---
Chapter {{ ch.get('number', '?') }}: {{ ch.get('title', 'Untitled') }}
Act: {{ ch.get('act', 'N/A') }}
Summary: {{ ch.get('summary', 'No summary') }}
{% if ch.get('scenes') %}
Scenes: {{ ch.get('scenes') | length }}
{% elif ch.get('key_events') %}
Key Events: {{ ch.get('key_events') | length }}
{% endif %}
{% endfor %}

VALIDATION CRITERIA:

1. **Arc Coherence**
   - Does the story have clear beginning (setup), middle (conflict), and end (resolution)?
   - Do the acts progress logically?
   - Is there a clear climax?

2. **Duplicate Events Check**
   - Are there redundant or repeated plot points across chapters?
   - Does each chapter serve a unique narrative purpose?

3. **Pacing Balance**
   - Are chapter lengths/complexity roughly balanced?
   - Is any chapter dramatically shorter or longer than others?
   - Does pacing match the story type (thriller = faster, literary = slower)?

4. **Character Arc Completeness**
   - Do main characters have setup AND payoff?
   - Are character motivations consistent throughout?
   - Do character arcs reach satisfying conclusions?

5. **Plot Coherence**
   - Are there any obvious plot holes or logical gaps?
   - Do cause-and-effect relationships make sense?
   - Are all major plot threads addressed by the end?

RETURN FORMAT:
Return ONLY valid JSON (no markdown fences):

{
  "verdict": "pass" or "needs_work" or "blocked",
  "reasoning": "Detailed explanation of the overall assessment",
  "issues": [
    "Issue 1: Description of specific structural problem",
    "Issue 2: Another structural issue found"
  ],
  "suggestions": [
    "Suggestion 1: How to fix the issue",
    "Suggestion 2: Alternative approach"
  ]
}

VERDICT MEANINGS:
- "pass": Structure is solid, proceed to prose generation
- "needs_work": Minor issues that can be auto-fixed with iteration
- "blocked": Major structural problems requiring human review

Be thorough but practical. Minor imperfections are acceptable if the overall structure is sound.
